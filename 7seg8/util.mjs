#!/usr/bin/bun
import{$}from'bun';
const d={
	undefined:'\u0020',
	'\u0020':0,'\t':0,'!':0b01000001,
	'"':0b01000100,"'":0b01000000,
	'(':'[',')':']',
	',':'.','-':0b00000010,'.':1,'/':0b01001010,
	0:0b11111100,1:0b01100000,2:0b11011010,3:0b11110010,
	4:0b01100110,5:0b10110110,6:0b10111110,7:0b11100000,
	8:0b11111110,9:0b11110110,
	'=':0b00010010,'?':0b11000001,
	A:0b11101110,a:'A',
	B:'b',b:0b00111110,
	C:0b10011100,c:0b00011010,
	D:'d',d:0b01111010,
	E:0b10011110,e:'E',
	F:0b10001110,f:'F',
	G:0b10111100,g:'G',
	H:0b01101110,h:0b00101110,
	I:'1',i:0b00100000,
	J:0b11111000,j:0b01111000,
	L:0b00011100,l:'L',
	N:'n',n:0b00101010,
	O:'0',o:0b00111010,
	P:'p',p:0b11001110,
	Q:'q',q:0b11100110,
	R:'r',r:0b00001010,
	S:'5',s:'5',
	T:'t',t:0b00011110,
	U:0b01111100,u:0b00111000,
	Y:'y',y:0b01110110,
	'[':0b10011100,'\\':0b00100110,']':0b11110000,
	'^':0b10000000,'_':0b00010000,'\`':"'",'{':'[','|':'1','}':']','~':'-'
},
c2seg=x=>(x=d[x],x==void 0?d['?']:typeof x=='string'?c2seg(x):x),
a2b=(w,addr)=>(
	w=[...w,...[...Array(Math.ceil(w.length/8)*8-w.length)].map(_=>({seg:0,bri:0}))],
	new Uint8Array([...Array(w.length/8)].flatMap((x,i)=>(
		x=w.slice(i*8,i*8+8),
		[...(addr?[addr+i,10]:[]),...x.map(x=>x.seg),...(x=>[x&0x00ff,x>>>8])(x.reduce((a,x,i)=>a|((x.bri&3)<<(i*2)),0))]
	)))
);

await $`stty -F /dev/ttyUSB0 115200 -onlcr -echo -echoctl`;

export{d,c2seg,a2b};
